# External Authentication

In this example we deploy a web application, configure load balancing using Ingress resources with the
master/minion (mergeable) pattern, and apply external authentication using two different methods:

1. **HTTP Basic Auth** — using an NGINX service that validates credentials from an htpasswd file.
2. **OAuth2 Proxy with Keycloak** — using [oauth2-proxy](https://oauth2-proxy.github.io/oauth2-proxy/) to authenticate
   users against a [Keycloak](https://www.keycloak.org/) OpenID Connect provider.

## Prerequisites

1. Follow the [installation](https://docs.nginx.com/nginx-ingress-controller/install/manifests)
   instructions to deploy NGINX Ingress Controller.
2. Generate the required secrets by running from the root of the repository:

    ```shell
    make secrets
    ```

    This creates the TLS and htpasswd secrets as symlinks via `hack/secrets-gen`.

3. Save the public IP address of the Ingress Controller into a shell variable:

    ```shell
    IC_IP=XXX.YYY.ZZZ.III
    ```

4. Save the HTTPS port of the Ingress Controller into a shell variable:

    ```shell
    IC_HTTPS_PORT=<port number>
    ```

5. Add the following entries to `/etc/hosts`:

    ```text
    XXX.YYY.ZZZ.III cafe.example.com
    XXX.YYY.ZZZ.III keycloak.example.com
    ```

## Step 1 - Deploy TLS Secrets

Apply the generated TLS secrets:

```shell
kubectl apply -f tls-secret.yaml
kubectl apply -f keycloak-tls-secret.yaml
```

## Step 2 - Deploy the Web Application

Deploy the cafe application (tea and coffee backends):

```shell
kubectl apply -f cafe.yaml
```

## Step 3 - Deploy the Basic Auth Backend

Deploy the NGINX basic-auth service (the htpasswd secret is generated by `make secrets`):

```shell
kubectl apply -f htpasswd-secret.yaml
kubectl apply -f basic-auth.yaml
```

## Step 4 - Deploy Keycloak

Deploy Keycloak and expose it via an Ingress resource:

```shell
kubectl apply -f keycloak.yaml
kubectl apply -f keycloak-ingress.yaml
```

Wait for Keycloak to become ready:

```shell
kubectl wait --for=condition=Ready pod -l app=keycloak --timeout=120s
```

Then configure Keycloak by following the steps in [keycloak_setup.md](keycloak_setup.md).

When creating the client in Keycloak, make sure to:

- Set the **Client ID** to `nginx-plus`.
- Set **Valid Redirect URIs** to `https://cafe.example.com:443/_oauth2/callback`.
- Enable **Client authentication** to generate a client secret.

## Step 5 - Deploy OAuth2 Proxy

1. Update the client secret in `oauth2-proxy-client-secret.yaml` with the secret obtained from Keycloak:

    ```shell
    echo -n '<your-keycloak-client-secret>' | base64
    ```

    Replace the value of `client-secret` in the file, then apply:

    ```shell
    kubectl apply -f oauth2-proxy-client-secret.yaml
    ```

2. Deploy oauth2-proxy:

    ```shell
    kubectl apply -f oauth2-proxy.yaml
    ```

## Step 6 - Deploy the Ingress Resources

Deploy the master Ingress that configures TLS and the internal auth subrequest endpoints via `server-snippets`:

```shell
kubectl apply -f cafe-ingress-master.yaml
```

Deploy the minion Ingress for `/tea` (protected by basic-auth):

```shell
kubectl apply -f tea-minion.yaml
```

Deploy the minion Ingress for `/coffee` (protected by oauth2-proxy):

```shell
kubectl apply -f coffee-minion.yaml
```

Deploy the minion Ingress for `/_oauth2` (oauth2-proxy callback and start endpoints):

```shell
kubectl apply -f oauth2-proxy-minion.yaml
```

## Testing

### Basic Auth Route (`/tea`)

Access `https://cafe.example.com/tea`. You will be prompted for credentials.
Use the credentials from the htpasswd secret (default: `foo` / `bar`):

```shell
curl --resolve cafe.example.com:$IC_HTTPS_PORT:$IC_IP \
  https://cafe.example.com:$IC_HTTPS_PORT/tea -u foo:bar --insecure
```

### OAuth2 Proxy Route (`/coffee`)

Open `https://cafe.example.com/coffee` in a browser. You will be redirected to Keycloak to log in.
After successful authentication, you will be redirected back to the application.

Use the Keycloak user credentials (`nginx-user` / `test` if you followed the Keycloak setup guide).

### Unprotected Route (`/_oauth2`)

The `/_oauth2` path routes to oauth2-proxy for handling OAuth2 callbacks and is not directly user-facing.

## Architecture

This example uses the [Mergeable Ingress](https://docs.nginx.com/nginx-ingress-controller/configuration/ingress-resources/cross-namespace-configuration/)
pattern to split the configuration across multiple Ingress resources:

- **Master** (`cafe-ingress-master.yaml`) — Defines the host, TLS termination, and `server-snippets` containing
  internal subrequest locations for basic-auth and oauth2-proxy authentication checks.
- **Tea Minion** (`tea-minion.yaml`) — Routes `/tea` to the tea service, using `location-snippets` to add
  `auth_request /basic-auth;` for HTTP basic authentication.
- **Coffee Minion** (`coffee-minion.yaml`) — Routes `/coffee` to the coffee service, using `location-snippets` to
  add `auth_request /_oauth2/auth;` and related directives for OAuth2 authentication.
- **OAuth2 Proxy Minion** (`oauth2-proxy-minion.yaml`) — Routes `/_oauth2` to oauth2-proxy for handling the
  OAuth2 callback and start flow.

## File Overview

| File | Description |
| ------ | ------------- |
| `cafe.yaml` | Tea and coffee backend deployments and services |
| `basic-auth.yaml` | NGINX basic-auth deployment, ConfigMap, and service |
| `htpasswd-secret.yaml` | htpasswd secret with user credentials |
| `keycloak.yaml` | Keycloak deployment and service |
| `keycloak-tls-secret.yaml` | TLS secret for Keycloak |
| `keycloak_setup.md` | Guide to configure Keycloak users and clients |
| `keycloak-ingress.yaml` | Ingress exposing Keycloak |
| `oauth2-proxy.yaml` | oauth2-proxy deployment, ConfigMap, and service |
| `oauth2-proxy-client-secret.yaml` | Secret holding the Keycloak client secret for oauth2-proxy |
| `tls-secret.yaml` | TLS secret for cafe.example.com |
| `cafe-ingress-master.yaml` | Master Ingress with TLS and auth subrequest server-snippets |
| `tea-minion.yaml` | Minion Ingress for `/tea` with basic-auth |
| `coffee-minion.yaml` | Minion Ingress for `/coffee` with oauth2-proxy |
| `oauth2-proxy-minion.yaml` | Minion Ingress for `/_oauth2` callback handling |
