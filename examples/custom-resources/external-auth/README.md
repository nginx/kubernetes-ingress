# External Authentication

In this example we deploy a web application, configure load balancing with a VirtualServer, and apply external
authentication using two different methods:

1. **HTTP Basic Auth** — using an NGINX service that validates credentials from an htpasswd file.
2. **OAuth2 Proxy with Keycloak** — using [oauth2-proxy](https://oauth2-proxy.github.io/oauth2-proxy/) to authenticate
   users against a [Keycloak](https://www.keycloak.org/) OpenID Connect provider.

## Prerequisites

1. Follow the [installation](https://docs.nginx.com/nginx-ingress-controller/install/manifests)
   instructions to deploy NGINX Ingress Controller with custom resources enabled.
2. Generate the required secrets by running from the root of the repository:

    ```shell
    make secrets
    ```

    This creates the TLS and htpasswd secrets as symlinks via `hack/secrets-gen`.

3. Save the public IP address of the Ingress Controller into `/etc/hosts` of your machine:

    ```text
    XXX.YYY.ZZZ.III cafe.example.com
    XXX.YYY.ZZZ.III keycloak.example.com
    ```

## Step 1 - Deploy TLS Secrets

Apply the generated TLS secrets:

```shell
kubectl apply -f tls-secret.yaml
kubectl apply -f keycloak-tls-secret.yaml
```

## Step 2 - Deploy the Web Application

Deploy the cafe application (tea and coffee backends):

```shell
kubectl apply -f cafe.yaml
```

## Step 3 - Deploy the Basic Auth Backend

Deploy the NGINX basic-auth service (the htpasswd secret is generated by `make secrets`):

```shell
kubectl apply -f htpasswd-secret.yaml
kubectl apply -f basic-auth.yaml
```

## Step 4 - Deploy Keycloak

Deploy Keycloak and expose it via a VirtualServer:

```shell
kubectl apply -f keycloak.yaml
kubectl apply -f virtual-server-idp.yaml
```

Wait for Keycloak to become ready:

```shell
kubectl wait --for=condition=Ready pod -l app=keycloak --timeout=120s
```

Then configure Keycloak by following the steps in [keycloak_setup.md](keycloak_setup.md).

When creating the client in Keycloak, make sure to:

- Set the **Client ID** to `nginx-plus`.
- Set **Valid Redirect URIs** to `https://cafe.example.com:443/_oauth2/callback`.
- Enable **Client authentication** to generate a client secret.

## Step 5 - Deploy OAuth2 Proxy

1. Update the client secret in `oauth2-proxy-client-secret.yaml` with the secret obtained from Keycloak:

    ```shell
    echo -n '<your-keycloak-client-secret>' | base64
    ```

    Replace the value of `client-secret` in the file, then apply:

    ```shell
    kubectl apply -f oauth2-proxy-client-secret.yaml
    ```

2. Deploy oauth2-proxy:

    ```shell
    kubectl apply -f oauth2-proxy.yaml
    ```

## Step 6 - Deploy the VirtualServer

Deploy the VirtualServer that ties everything together — `/tea` is protected by basic-auth,
`/coffee` is protected by oauth2-proxy, and the root path is unprotected:

```shell
kubectl apply -f cafe-virtual-server.yaml
```

## Testing

### Basic Auth Route (`/tea`)

Access `https://cafe.example.com/tea`. You will be prompted for credentials.
Use the credentials from the htpasswd secret (default: `foo` / `bar`):

```shell
curl -k -u foo:bar https://cafe.example.com/tea
```

### OAuth2 Proxy Route (`/coffee`)

Open `https://cafe.example.com/coffee` in a browser. You will be redirected to Keycloak to log in.
After successful authentication, you will be redirected back to the application.

Use the Keycloak user credentials (`nginx-user` / `test` if you followed the Keycloak setup guide).

### Unprotected Route (`/`)

The root path has no authentication and is publicly accessible:

```shell
curl -k https://cafe.example.com/
```

## File Overview

| File | Description |
| ------ | ------------- |
| `cafe.yaml` | Tea and coffee backend deployments and services |
| `basic-auth.yaml` | NGINX basic-auth deployment, ConfigMap, and service |
| `htpasswd-secret.yaml` | htpasswd secret with user credentials |
| `keycloak.yaml` | Keycloak deployment and service |
| `keycloak-tls-secret.yaml` | TLS secret for Keycloak |
| `keycloak_setup.md` | Guide to configure Keycloak users and clients |
| `virtual-server-idp.yaml` | VirtualServer exposing Keycloak |
| `oauth2-proxy.yaml` | oauth2-proxy deployment, ConfigMap, and service |
| `oauth2-proxy-client-secret.yaml` | Secret holding the Keycloak client secret for oauth2-proxy |
| `tls-secret.yaml` | TLS secret for cafe.example.com |
| `cafe-virtual-server.yaml` | VirtualServer with basic-auth and oauth2-proxy routes |
