
upstream vs_cafe_cafe_vsr_cafe_coffee_coffee {
    zone vs_cafe_cafe_vsr_cafe_coffee_coffee 512k;
    random two least_conn;
    server 10.244.0.5:8080 max_fails=1 fail_timeout=10s max_conns=0;
}

upstream vs_cafe_cafe_vsr_cafe_tea_tea {
    zone vs_cafe_cafe_vsr_cafe_tea_tea 512k;
    random two least_conn;
    server 10.244.0.4:8080 max_fails=1 fail_timeout=10s max_conns=0;
}

auth_jwt_claim_set $jwt_cafe_cafe_sub sub;
map $jwt_cafe_cafe_sub $GroupName {
    default     Group1;
    Gold        Group3;
    Silver      Group2;
    Bronze      Group1;
}
# bronze_zone map
map $GroupName $bronze_zone {
    default       '';
    Group1        $jwt_claim_sub;
}
# silver_zone map
map $GroupName $silver_zone {
    default       '';
    Group2        $jwt_claim_sub;
}
# gold_zone map
map $GroupName $gold_zone {
    default       '';
    Group3        $jwt_claim_sub;
}

limit_req_zone ${jwt_claim_sub} zone=pol_rl_cafe_rate-limit-jwt-gold_cafe_cafe:10M rate=20r/s;
limit_req_zone ${jwt_claim_sub} zone=pol_rl_cafe_rate-limit-jwt-silver_cafe_cafe:10M rate=10r/s;
limit_req_zone ${jwt_claim_sub} zone=pol_rl_cafe_rate-limit-jwt-bronze_cafe_cafe:10M rate=1r/s;
limit_req_zone ${jwt_claim_sub} zone=pol_rl_cafe_rate-limit-jwt-gold2_cafe_cafe:10M rate=25r/s;
limit_req_zone ${jwt_claim_sub} zone=pol_rl_cafe_rate-limit-jwt-silver2_cafe_cafe:10M rate=15r/s;
limit_req_zone ${jwt_claim_sub} zone=pol_rl_cafe_rate-limit-jwt-bronze2_cafe_cafe:10M rate=2r/s;

server {
    listen 80;
    listen [::]:80;


    server_name cafe.example.com;
    status_zone cafe.example.com;
    set $resource_type "virtualserver";
    set $resource_name "cafe";
    set $resource_namespace "cafe";
    listen 443 ssl;
    listen [::]:443 ssl;

    ssl_certificate $secret_dir_path/cafe-cafe-secret;
    ssl_certificate_key $secret_dir_path/cafe-cafe-secret;

    server_tokens "on";
    limit_req_log_level error;
    limit_req_status 503;
    limit_req zone=pol_rl_cafe_rate-limit-jwt-gold_cafe_cafe;
    limit_req zone=pol_rl_cafe_rate-limit-jwt-silver_cafe_cafe;
    limit_req zone=pol_rl_cafe_rate-limit-jwt-bronze_cafe_cafe;




    location /tea {
        set $service "tea-svc";
        status_zone "tea-svc";
        set $resource_type "virtualserverroute";
        set $resource_name "tea";
        set $resource_namespace "cafe";


        set $default_connection_header close;
        proxy_connect_timeout 60s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
        client_max_body_size 1m;

        proxy_buffering on;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $vs_connection_header;
        proxy_pass_request_headers on;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host "$host";
        proxy_pass http://vs_cafe_cafe_vsr_cafe_tea_tea;
        proxy_next_upstream error timeout;
        proxy_next_upstream_timeout 0s;
        proxy_next_upstream_tries 0;
    }
    location /coffee {
        set $service "coffee-svc";
        status_zone "coffee-svc";
        set $resource_type "virtualserverroute";
        set $resource_name "coffee";
        set $resource_namespace "cafe";
        limit_req_log_level error;
        limit_req_status 503;
        limit_req zone=pol_rl_cafe_rate-limit-jwt-gold2_cafe_cafe;
        limit_req zone=pol_rl_cafe_rate-limit-jwt-silver2_cafe_cafe;
        limit_req zone=pol_rl_cafe_rate-limit-jwt-bronze2_cafe_cafe;


        set $default_connection_header close;
        proxy_connect_timeout 60s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
        client_max_body_size 1m;

        proxy_buffering on;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $vs_connection_header;
        proxy_pass_request_headers on;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host "$host";
        proxy_pass http://vs_cafe_cafe_vsr_cafe_coffee_coffee;
        proxy_next_upstream error timeout;
        proxy_next_upstream_timeout 0s;
        proxy_next_upstream_tries 0;
    }


}
