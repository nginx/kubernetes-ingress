# githubscan Package

This package implements the GitHub Actions artifact scanning workflow using Bubble Tea TUI framework.

## File Structure

### Core Files

- **model.go** - Contains the main `Model` struct, state enums, and initialization logic
  - `Model`: The Bubble Tea model that manages the entire workflow state
  - `githubStep`: Enum for workflow steps (select branch, fetch artifacts, etc.)
  - `artifactStatus`: Enum for tracking artifact download status
  - `InitialModel()`: Creates and initializes a new Model

- **branch.go** - Branch fetching, parsing, and validation
  - `fetchBranches()`: Retrieves all release-* branches from GitHub API
  - `validateBranch()`: Checks if a custom branch exists
  - `sortReleasesBranches()`: Sorts release branches by semantic version (descending)

- **update.go** - Handles all state updates and message processing
  - `Update()`: Main update function that processes all messages
  - `handleBranchSelection()`: Handles branch list and custom input
  - `handleSarifSelection()`: Handles SARIF file multi-select
  - `handleConfirmation()`: Handles yes/no confirmation
  - `handleCleanup()`: Handles keep/delete temp directory

- **view.go** - Renders the UI for different workflow steps
  - `View()`: Main view function that renders based on current state
  - `renderBranchSelection()`: Renders branch list with custom input option
  - `renderArtifactDownload()`: Renders download progress with progress bar
  - `renderConfirmation()`: Renders yes/no confirmation screen
  - `renderCleanup()`: Renders keep/delete temp directory screen
  - `renderComplete()`: Renders final success/error message

### Data Types

- **sarif_files.go** - SARIF file related types and functions
  - `sarifFile`: Implements `list.Item` interface for SARIF files
  - `loadSarifFilesList()`: Loads SARIF files from the output directory

### UI Components

- **delegate.go** - Custom list delegate for rendering selectable items
  - `selectDelegate`: Custom delegate that shows checkmarks and cursors
  - `branchItem`: Simple branch item for list display
  - Handles SARIF file items with selection indicators

### Commands

- **commands.go** - Bubble Tea commands for async operations
  - `downloadArtifacts()`: Downloads artifacts from GitHub Actions in parallel
  - `parseAndRenderReport()`: Parses SARIF files and generates markdown report using the reporter package
  - Message types: `branchListMsg`, `artifactDownloadProgressMsg`, `artifactDownloadCompleteMsg`, `parseCompleteMsg`

## Dependencies

This package depends on:

- `githubartifacts` package for GitHub API interaction and artifact download
- `reporter` package for SARIF parsing and markdown generation
- `common` package for shared utilities
- GitHub API via `github.com/google/go-github/v82`

## Workflow Steps

1. **StepSelectBranch** - Select main, release-*, or enter custom version
2. **StepFetchingArtifacts** - Download artifacts with progress indication
3. **StepSelectSarifFiles** - Choose which SARIF files to include in report
4. **StepConfirmSelection** - Confirm before report generation
5. **StepParseAndRender** - Generate markdown report
6. **StepAskCleanup** - Keep or delete temporary directory
7. **StepComplete** - Show results

## Key Features

- **Dynamic Branch Fetching**: Retrieves branches from GitHub API
- **Semantic Version Sorting**: Sorts release-* branches by version (5.4, 5.3, 5.2...)
- **Custom Version Input**: Text field for entering non-listed versions (e.g., "4.9")
- **Parallel Downloads**: All artifacts downloaded concurrently
- **Progress Tracking**: Progress bar and per-artifact status indicators
- **Multi-select SARIF Files**: Choose which artifacts to include in report
- **Styled UI**: Uses lipgloss for consistent button styling
- **Error Handling**: Comprehensive error handling at each step

## Branch Selection

The branch selection screen shows:

- **main** branch (always first)
- Last 5 **release-*** branches sorted by semantic version descending
- Text input field for custom versions (activated with Tab)

Example: If branches are release-5.4, release-5.3, release-5.2, release-5.1, release-5.0, release-4.9:

- Shows: main, release-5.4, release-5.3, release-5.2, release-5.1, release-5.0
- Can enter "4.9" in text field to fetch release-4.9

## Usage

```go
import "github.com/nginx/kubernetes-ingress/hack/cve-automation/githubscan"

// Create model
model, err := githubscan.InitialModel()
if err != nil {
    log.Fatal(err)
}

// Run Bubble Tea program
p := tea.NewProgram(model, tea.WithAltScreen())
if _, err := p.Run(); err != nil {
    log.Fatal(err)
}
```

## Architecture

Mirrors the `dockerscan` package structure for consistency:

- Same state machine pattern
- Same message-passing approach
- Same UI component patterns (progress bar, spinner, confirmation buttons)
- Reuses reporter package for SARIF processing
