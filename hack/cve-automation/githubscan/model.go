package githubscan

import (
	"github.com/charmbracelet/bubbles/key"
	"github.com/charmbracelet/bubbles/list"
	"github.com/charmbracelet/bubbles/progress"
	"github.com/charmbracelet/bubbles/spinner"
	"github.com/charmbracelet/bubbles/textinput"
	tea "github.com/charmbracelet/bubbletea"
)

// githubStep represents the current step in the GitHub workflow
type githubStep int

const (
	stepSelectBranch githubStep = iota
	stepFetchingArtifacts
	stepSelectSarifFiles
	stepConfirmSelection
	stepParseAndRender
	stepAskCleanup
	stepComplete
)

// artifactStatus represents the download status of an artifact
type artifactStatus int

const (
	statusPending artifactStatus = iota
	statusInProgress
	statusDone
)

// confirmChoice represents the user's confirmation selection

// Model represents the GitHub artifact scanner TUI state
type Model struct {
	// State
	state githubStep
	err   error

	// Branch selection
	branches        []string
	branchList      list.Model
	selectedBranch  string
	customInput     textinput.Model
	showCustomInput bool

	// Artifact download
	outputDir        string
	randomSuffix     string
	downloadProgress float64
	artifactStatuses map[string]artifactStatus
	progressMessage  string

	// SARIF selection
	sarifList      list.Model
	selectedSarifs map[string]struct{}

	// Report generation
	confirmSelection   bool
	confirmationChoice confirmChoice
	reportPath         string

	// Cleanup
	cleanupChoice    confirmChoice
	tempDirToCleanup string

	// UI components
	spinner spinner.Model
	prog    progress.Model
	keys    keyMap

	// Window dimensions
	windowWidth  int
	windowHeight int
}

// keyMap defines keyboard shortcuts
type keyMap struct {
	up        key.Binding
	down      key.Binding
	enter     key.Binding
	space     key.Binding
	quit      key.Binding
	tab       key.Binding
	esc       key.Binding
	left      key.Binding
	right     key.Binding
	selectAll key.Binding
}

// Init initializes the model
func (m Model) Init() tea.Cmd {
	return tea.Batch(
		m.spinner.Tick,
		fetchBranches(),
	)
}

// InitialModel creates and returns a new Model
func InitialModel() (Model, error) {
	// Initialize spinner
	s := spinner.New()
	s.Spinner = spinner.Dot
	s.Style = spinnerStyle

	// Initialize progress bar
	p := progress.New(progress.WithDefaultGradient())

	// Initialize text input for custom branch
	ti := textinput.New()
	ti.Placeholder = "e.g., 4.9"
	ti.CharLimit = 10
	ti.Width = 20

	// Initialize key bindings
	keys := keyMap{
		up:        key.NewBinding(key.WithKeys("up", "k")),
		down:      key.NewBinding(key.WithKeys("down", "j")),
		enter:     key.NewBinding(key.WithKeys("enter")),
		space:     key.NewBinding(key.WithKeys(" ")),
		quit:      key.NewBinding(key.WithKeys("q", "ctrl+c")),
		tab:       key.NewBinding(key.WithKeys("tab")),
		esc:       key.NewBinding(key.WithKeys("esc")),
		left:      key.NewBinding(key.WithKeys("left", "h")),
		right:     key.NewBinding(key.WithKeys("right", "l")),
		selectAll: key.NewBinding(key.WithKeys("ctrl+a")),
	}

	return Model{
		state:              stepSelectBranch,
		selectedSarifs:     make(map[string]struct{}),
		artifactStatuses:   make(map[string]artifactStatus),
		spinner:            s,
		prog:               p,
		keys:               keys,
		customInput:        ti,
		showCustomInput:    false,
		confirmSelection:   false,
		confirmationChoice: confirmNo,
		cleanupChoice:      confirmNo,
	}, nil
}
