package githubscan

import (
	"fmt"
	"sort"
	"strings"

	"github.com/charmbracelet/lipgloss"
	"github.com/nginx/kubernetes-ingress/hack/cve-automation/ui"
)

var spinnerStyle = lipgloss.NewStyle().Foreground(lipgloss.Color("205"))

// View renders the current state
func (m Model) View() string {
	switch m.state {
	case stepSelectBranch:
		return m.renderBranchSelection()
	case stepFetchingArtifacts:
		return m.renderArtifactDownload()
	case stepSelectSarifFiles:
		return ui.DocStyle.Render(m.sarifList.View())
	case stepConfirmSelection:
		return m.renderConfirmation()
	case stepParseAndRender:
		return m.renderParsing()
	case stepAskCleanup:
		return m.renderCleanup()
	case stepComplete:
		return m.renderComplete()
	default:
		return ui.DocStyle.Render("Unknown state")
	}
}

// renderBranchSelection renders the branch selection screen
func (m Model) renderBranchSelection() string {
	if m.branchList.Items() == nil {
		return ui.DocStyle.Render(fmt.Sprintf("%s Fetching branches...", m.spinner.View()))
	}

	var out strings.Builder
	out.WriteString(m.branchList.View())
	out.WriteString("\n\n(Press Enter to select, q to quit)")

	return ui.DocStyle.Render(out.String())
}

// renderArtifactDownload renders the artifact download progress
func (m Model) renderArtifactDownload() string {
	var out strings.Builder

	// Don't render anything until we have artifacts to show
	if len(m.artifactStatuses) == 0 {
		out.WriteString(spinnerStyle.Render(m.spinner.View()) + " " + m.progressMessage)
		return ui.DocStyle.Render(out.String())
	}

	out.WriteString(fmt.Sprintf("Downloading artifacts for branch: %s\n\n", m.selectedBranch))

	// Render progress bar
	out.WriteString(m.prog.ViewAs(m.downloadProgress))
	out.WriteString("\n\n")

	// Render list of artifacts with their status (sorted for stable display)
	// Convert map to sorted slice
	var names []string
	for name := range m.artifactStatuses {
		names = append(names, name)
	}
	sort.Strings(names)

	for _, name := range names {
		status := m.artifactStatuses[name]
		var icon string
		switch status {
		case statusPending:
			icon = "⏳"
		case statusInProgress:
			icon = m.spinner.View()
		case statusDone:
			icon = "✅"
		}
		out.WriteString(fmt.Sprintf("%s %s\n", icon, name))
	}

	return ui.DocStyle.Render(out.String())
}

// renderConfirmation renders the confirmation screen
func (m Model) renderConfirmation() string {
	var out strings.Builder

	out.WriteString(fmt.Sprintf("You have selected %d SARIF files:\n\n", len(m.selectedSarifs)))

	// Convert map to sorted slice for stable display
	var paths []string
	for path := range m.selectedSarifs {
		paths = append(paths, path)
	}
	// Sort alphabetically for stable order
	sort.Strings(paths)

	// Show all selected files
	for _, path := range paths {
		out.WriteString(fmt.Sprintf("  • %s\n", path))
	}

	out.WriteString("\n\nGenerate report from these files?\n\n")

	var yesButton, noButton string
	if m.confirmationChoice == confirmYes {
		yesButton = ui.ActiveButtonStyle.Render("Yes")
		noButton = ui.InactiveButtonStyle.Render("No")
	} else {
		yesButton = ui.InactiveButtonStyle.Render("Yes")
		noButton = ui.ActiveButtonStyle.Render("No")
	}

	out.WriteString(fmt.Sprintf("%s  %s\n\n", noButton, yesButton))
	out.WriteString("(Use arrow keys or tab to switch, Enter to confirm)")

	return ui.DocStyle.Render(out.String())
}

// renderParsing renders the parsing progress
func (m Model) renderParsing() string {
	return ui.DocStyle.Render(fmt.Sprintf("%s %s", m.spinner.View(), m.progressMessage))
}

// renderCleanup renders the cleanup confirmation screen
func (m Model) renderCleanup() string {
	var out strings.Builder

	if m.reportPath != "" {
		out.WriteString("✅ Report generated successfully!\n\n")
		out.WriteString(fmt.Sprintf("Report: %s\n\n", m.reportPath))
	}

	out.WriteString(fmt.Sprintf("Temp directory: %s\n\n", m.tempDirToCleanup))
	out.WriteString("Delete the temporary directory?\n\n")

	var yesButton, noButton string
	if m.cleanupChoice == confirmYes {
		yesButton = ui.ActiveButtonStyle.Render("Delete")
		noButton = ui.InactiveButtonStyle.Render("Keep")
	} else {
		yesButton = ui.InactiveButtonStyle.Render("Delete")
		noButton = ui.ActiveButtonStyle.Render("Keep")
	}

	out.WriteString(fmt.Sprintf("%s  %s\n\n", noButton, yesButton))
	out.WriteString("(Use arrow keys or tab to switch, Enter to confirm)")

	return ui.DocStyle.Render(out.String())
}

// renderComplete renders the completion screen
func (m Model) renderComplete() string {
	if m.err != nil {
		return ui.DocStyle.Render(fmt.Sprintf("❌ Error: %v\n\nPress Enter or q to exit.", m.err))
	}

	var out strings.Builder
	out.WriteString("✅ All done!\n\n")

	if m.reportPath != "" {
		out.WriteString(fmt.Sprintf("Report generated: %s\n\n", m.reportPath))
	}

	if m.cleanupChoice == confirmYes {
		out.WriteString("Temporary directory deleted.\n\n")
	} else {
		out.WriteString(fmt.Sprintf("Temporary directory kept: %s\n\n", m.tempDirToCleanup))
	}

	out.WriteString("Press Enter or q to exit.")

	return ui.DocStyle.Render(out.String())
}
