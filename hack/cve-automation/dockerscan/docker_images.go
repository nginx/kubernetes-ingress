package dockerscan

import (
	"context"
	"fmt"
	"time"

	"github.com/charmbracelet/bubbles/list"
	"github.com/moby/moby/client"
	"github.com/nginx/kubernetes-ingress/hack/cve-automation/ui"
)

const (
	getImagesTimeout = 20 * time.Second
	filterNGINX      = "nginx/*"
)

// dockerImage represents a Docker image that implements the list.Item interface
type dockerImage struct {
	title string
	id    string
	size  string
}

func (d dockerImage) FilterValue() string {
	return d.title
}

func (d dockerImage) Title() string { return d.title }

func (d dockerImage) Description() string {
	return d.size
}

// GetID returns the unique identifier for this docker image
func (d dockerImage) GetID() string {
	return d.id
}

// GetTitle returns the display title for this docker image
func (d dockerImage) GetTitle() string {
	return d.title
}

// getDockerImages returns a list of Docker images matching the nginx/* filter
func getDockerImages() (images []list.Item, err error) {
	return getImagesWithFilter(filterNGINX)
}

// getImagesWithFilter returns a list of docker images that match the given
// filter. If the filter is empty, it returns all images. Generally you will
// want to pass in `nginx/*` to get all images that start with `nginx/`.
func getImagesWithFilter(filter string) (images []list.Item, err error) {
	filters := make(map[string]map[string]bool)
	if filter != "" {
		filters["reference"] = map[string]bool{
			filter: true,
		}
	}

	// Create a new client that handles common environment variables
	// for configuration (DOCKER_HOST, DOCKER_API_VERSION), and does
	// API-version negotiation to allow downgrading the API version
	// when connecting with an older daemon version.
	apiClient, err := client.New(client.FromEnv)
	if err != nil {
		return nil, fmt.Errorf("could not create docker api client: %w", err)
	}
	defer func() {
		err = apiClient.Close()
		if err != nil {
			err = fmt.Errorf("closing docker api client: %w", err)
		}
	}()

	ctx, cxl := context.WithTimeout(context.Background(), getImagesTimeout)
	defer cxl()

	// list images
	result, err := apiClient.ImageList(ctx, client.ImageListOptions{
		All:     true,
		Filters: filters,
	})
	if err != nil {
		return nil, fmt.Errorf("could not list images: %w", err)
	}

	images = make([]list.Item, len(result.Items))

	for i, img := range result.Items {
		images[i] = dockerImage{
			id:    img.ID,
			title: img.RepoTags[0],
			size:  ui.HumanSizeBinary(img.Size),
		}
	}

	return images, nil
}
