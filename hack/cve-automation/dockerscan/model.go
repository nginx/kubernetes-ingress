package dockerscan

import (
	"github.com/charmbracelet/bubbles/list"
	"github.com/charmbracelet/bubbles/progress"
	"github.com/charmbracelet/bubbles/spinner"
	tea "github.com/charmbracelet/bubbletea"
	"github.com/charmbracelet/lipgloss"
	"github.com/nginx/kubernetes-ingress/hack/cve-automation/ui"
)

// dockerStep represents the current step in the Docker workflow
type dockerStep int

const (
	stepSelectImages dockerStep = iota
	stepConfirmSelection
	stepGenerateSarifs
	stepSelectSarifFiles
	stepParseAndRender
	stepAskCleanup
	stepComplete
)

// imageStatus represents the status of a Docker image during SARIF generation
type imageStatus int

const (
	statusPending imageStatus = iota
	statusInProgress
	statusDone
)

// Model is the Bubble Tea model for the Docker image scanning workflow.
// It manages the entire flow from selecting Docker images, generating SARIF files,
// selecting which SARIF files to include in the report, and cleanup.
type Model struct {
	filter           string
	images           list.Model
	selected         map[string]struct{}
	state            dockerStep
	confirmSelection bool
	outputDir        string
	randomSuffix     string
	reportPath       string // Path to generated report
	err              error
	progressLog      []string               // Log of progress messages during SARIF generation
	progressBar      progress.Model         // Progress bar for SARIF generation
	spinner          spinner.Model          // Spinner for in-progress items
	imageStatuses    map[string]imageStatus // Track status of each image being scanned
	keepTempDir      bool                   // true = keep, false = delete
	sarifFiles       list.Model             // List of generated SARIF files
	selectedSarifs   map[string]struct{}    // Selected SARIF files for report
	windowWidth      int                    // Current window width
	windowHeight     int                    // Current window height
}

// Init initializes the model and returns the initial command
func (m Model) Init() tea.Cmd {
	return m.spinner.Tick
}

// InitialModel creates and returns a new Model with Docker images loaded
func InitialModel(filterNGINX string) (Model, error) {
	images, err := getDockerImages()
	if err != nil {
		return Model{}, err
	}

	selected := make(map[string]struct{})
	l := list.New(images, ui.NewSelectDelegate(&selected), 0, 0)
	l.Title = "Select which Docker images to include in the report"
	l.SetShowTitle(true)
	l.SetShowFilter(true)

	// Create progress bar
	prog := progress.New(progress.WithDefaultGradient())

	// Create spinner
	s := spinner.New()
	s.Spinner = spinner.Dot
	s.Style = lipgloss.NewStyle().Foreground(lipgloss.Color("205"))

	return Model{
		filter:         filterNGINX,
		images:         l,
		selected:       selected,
		progressBar:    prog,
		spinner:        s,
		imageStatuses:  make(map[string]imageStatus),
		selectedSarifs: make(map[string]struct{}),
	}, nil
}
