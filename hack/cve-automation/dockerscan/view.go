package dockerscan

import (
	"fmt"
	"strings"

	"github.com/nginx/kubernetes-ingress/hack/cve-automation/ui"
)

// View renders the current state of the model
func (m Model) View() string {
	switch m.state {
	case stepSelectImages:
		return ui.DocStyle.Render(m.images.View())
	case stepConfirmSelection:
		return m.renderConfirmation()
	case stepGenerateSarifs:
		return m.renderProgress()
	case stepSelectSarifFiles:
		return ui.DocStyle.Render(m.sarifFiles.View())
	case stepParseAndRender:
		return ui.DocStyle.Render("Parsing SARIF files and generating report...")
	case stepAskCleanup:
		return m.renderCleanupConfirmation()
	case stepComplete:
		if m.err != nil {
			return ui.DocStyle.Render(fmt.Sprintf("❌ Error: %v\n\nPress Enter to exit.", m.err))
		}
		msg := "✅ All done!\n\n"
		if m.reportPath != "" {
			msg += fmt.Sprintf("Report generated: %s\n\n", m.reportPath)
		}
		if m.keepTempDir && m.outputDir != "" {
			msg += fmt.Sprintf("Temp directory kept: %s\n\n", m.outputDir)
		}
		msg += "Press Enter to exit."
		return ui.DocStyle.Render(msg)
	default:
		return ui.DocStyle.Render("Unknown state")
	}
}

// renderConfirmation renders the initial confirmation screen
func (m Model) renderConfirmation() string {
	out := fmt.Sprintf("You have selected the following %d images:\n\n", len(m.selected))
	out += strings.Join(m.getSelectedImageTitles(), "\n")
	out += "\n\nGenerate SARIF files for these images?\n\n"

	// Render yes/no options as styled buttons
	var yesButton, noButton string

	if m.confirmSelection {
		yesButton = ui.ActiveButtonStyle.Render("Yes")
		noButton = ui.InactiveButtonStyle.Render("No")
	} else {
		yesButton = ui.InactiveButtonStyle.Render("Yes")
		noButton = ui.ActiveButtonStyle.Render("No")
	}

	out += fmt.Sprintf("%s  %s\n\n", noButton, yesButton)
	out += "(Use arrow keys or tab to switch, Enter to confirm)"

	return ui.DocStyle.Render(out)
}

// getSelectedImageTitles returns a list of selected image titles
func (m Model) getSelectedImageTitles() []string {
	titles := make([]string, 0, len(m.selected))
	for _, item := range m.images.Items() {
		img := item.(dockerImage)
		if _, exists := m.selected[img.id]; exists {
			titles = append(titles, img.title)
		}
	}
	return titles
}

// renderCleanupConfirmation renders the cleanup confirmation screen
func (m Model) renderCleanupConfirmation() string {
	out := fmt.Sprintf("✅ Generated %d SARIF files successfully!\n\n", len(m.selected))
	if m.reportPath != "" {
		out += fmt.Sprintf("Report generated: %s\n\n", m.reportPath)
	}
	out += fmt.Sprintf("Temp directory: %s\n\n", m.outputDir)
	out += "Keep the temporary directory?\n\n"

	// Render keep/delete options as styled buttons
	var keepButton, deleteButton string

	if m.keepTempDir {
		keepButton = ui.ActiveButtonStyle.Render("Keep")
		deleteButton = ui.InactiveButtonStyle.Render("Delete")
	} else {
		keepButton = ui.InactiveButtonStyle.Render("Keep")
		deleteButton = ui.ActiveButtonStyle.Render("Delete")
	}

	out += fmt.Sprintf("%s  %s\n\n", deleteButton, keepButton)
	out += "(Use arrow keys or tab to switch, Enter to confirm)"

	return ui.DocStyle.Render(out)
}

// renderProgress renders the SARIF generation progress screen
func (m Model) renderProgress() string {
	var out strings.Builder

	out.WriteString("Generating SARIF files...\n\n")

	// Render progress bar
	out.WriteString(m.progressBar.View() + "\n\n")

	// Render list of images with their status
	for _, item := range m.images.Items() {
		img := item.(dockerImage)
		status, exists := m.imageStatuses[img.title]
		if !exists {
			continue // Skip unselected images
		}

		var statusIcon string
		switch status {
		case statusPending:
			statusIcon = "⏳" // Hourglass for pending
		case statusInProgress:
			statusIcon = m.spinner.View() // Animated spinner for in progress
		case statusDone:
			statusIcon = "✅" // White checkmark on green
		}

		out.WriteString(fmt.Sprintf("%s %s\n", statusIcon, img.title))
	}

	return ui.DocStyle.Render(out.String())
}
