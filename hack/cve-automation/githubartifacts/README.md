# githubartifacts Package

This package handles downloading and extracting GitHub Actions artifacts containing SARIF vulnerability scan results.

## Files

### artifacts.go

Handles GitHub API interaction to retrieve artifact information:

**Constants:**

- `Owner` - GitHub repository owner (nginx)
- `Repo` - GitHub repository name (kubernetes-ingress)
- `ImagePromotionWorkflowID` - Workflow ID to query for artifacts

**Types:**

- `ArtifactInfo` - Holds artifact name and download URL

**Functions:**

- `GetArtifactURLs(token, branch string)` - Retrieves artifact URLs from the most recent successful workflow run for a given branch

### auth.go

Manages GitHub authentication:

**Functions:**

- `GetToken()` - Attempts to get GitHub token via `gh` CLI first, falls back to `GITHUB_TOKEN` environment variable

### download.go

Handles parallel artifact downloads:

**Constants:**

- `DownloadFolder` - Directory where artifacts are downloaded ("downloads")
- `maxZipBytes` - Maximum zip file size (30 MiB) to prevent decompression bombs

**Functions:**

- `DownloadArtifacts(artifacts []ArtifactInfo, baseDirectory string)` - Downloads all artifacts in parallel to a timestamped directory
- `downloadSingleArtifact()` - Downloads a single artifact (internal)

### extract.go

Extracts SARIF files from downloaded zip archives:

**Functions:**

- `extractAndProcessZip(zipPath, artifactName, outputDir string)` - Extracts SARIF JSON file from zip, renames it to match artifact name, and deletes the zip

### utils.go

Utility functions:

**Functions:**

- `generateTempDirName()` - Creates unique directory name in format `YYYYMMDD-HHMMSS-<6-random-chars>`

## Workflow

1. **Authentication**: Call `GetToken()` to obtain GitHub API token
2. **List Artifacts**: Call `GetArtifactURLs(token, branch)` to get artifact download URLs
3. **Download & Extract**: Call `DownloadArtifacts(artifacts, baseDir)` to download and extract all artifacts in parallel

## Usage Example

```go
import "github.com/nginx/kubernetes-ingress/hack/cve-automation/githubartifacts"

// Get GitHub token
token, err := githubartifacts.GetToken()
if err != nil {
    // handle error
}

// Get artifact URLs for main branch
artifacts, err := githubartifacts.GetArtifactURLs(token, "main")
if err != nil {
    // handle error
}

// Download and extract all artifacts
outputDir, err := githubartifacts.DownloadArtifacts(artifacts, "/project/root")
if err != nil {
    // handle error
}

// outputDir now contains extracted .sarif.json files
```

## Key Features

- **Parallel Downloads**: All artifacts downloaded concurrently for speed
- **Fail-Fast**: Stops all downloads if any single download fails
- **Automatic Extraction**: Zip files automatically extracted and deleted
- **Unique Directories**: Each download session gets a unique timestamped directory
- **Security**: File size limits prevent decompression bomb attacks
- **Flexible Auth**: Supports both `gh` CLI and environment variable authentication
