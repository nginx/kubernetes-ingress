package githubartifacts

import (
	"context"
	"fmt"
	"path/filepath"
	"regexp"

	"github.com/google/go-github/v82/github"
	"golang.org/x/oauth2"
)

const (
	// Owner is the GitHub repository to list artifacts from. This is currently
	// hardcoded to the nginx organization.
	Owner = "nginx"

	// Repo is the repository within the organization. This is currently
	// hardcoded to the kubernetes-ingress repository.
	Repo = "kubernetes-ingress"

	// ImagePromotionWorkflowID is the ID of the workflow to check the runs
	// against. To get this, query the repository's workflows using the GitHub
	// API and look for the workflow named "Image Promotion". The ID is included
	// in the response. This is currently hardcoded, but could be made
	// configurable in the future.
	//
	// client.Actions.ListWorkflows(ctx, owner, repo, &github.ListOptions{
	//     Page: 0,
	//     PerPage: 100,
	// })
	ImagePromotionWorkflowID = 103448112
)

// ArtifactInfo holds information about a GitHub artifact
type ArtifactInfo struct {
	Name string
	URL  string
}

// Path returns the full path where the artifact's zip file will be saved
func (a ArtifactInfo) Path(baseDirectory string) string {
	return filepath.Join(baseDirectory, a.Name+".zip")
}

// GetArtifactURLs retrieves artifact download URLs for a given branch
// from the most recent successful workflow run
func GetArtifactURLs(token, branch string) ([]ArtifactInfo, error) {
	ctx := context.Background()
	tokenSource := oauth2.StaticTokenSource(&oauth2.Token{AccessToken: token})
	oauth2Client := oauth2.NewClient(ctx, tokenSource)

	client := github.NewClient(oauth2Client)

	// Grab the most recent successful workflow run for the specified branch.
	runs, _, err := client.Actions.ListWorkflowRunsByID(ctx, Owner, Repo, ImagePromotionWorkflowID, &github.ListWorkflowRunsOptions{
		Branch:              branch,
		Status:              "success",
		ExcludePullRequests: false,
		ListOptions: github.ListOptions{
			PerPage: 1,
		},
	})
	if err != nil {
		return nil, fmt.Errorf("listing workflow runs for branch %s: %w", branch, err)
	}

	if len(runs.WorkflowRuns) < 1 {
		return nil, fmt.Errorf("no successful workflow runs found for branch %s", branch)
	}

	workflowRunID := runs.WorkflowRuns[0].GetID()

	// Grab the artifacts for the workflow run.
	artifacts, _, err := client.Actions.ListWorkflowRunArtifacts(ctx, Owner, Repo, workflowRunID, &github.ListOptions{Page: 0, PerPage: 100})
	if err != nil {
		return nil, fmt.Errorf("listing workflow run artifacts for run %d on branch %s at url %s: %w",
			workflowRunID, branch, runs.WorkflowRuns[0].GetURL(), err)
	}

	resultsRe, err := regexp.Compile(fmt.Sprintf("^%s.+-results$", branch))
	if err != nil {
		return nil, fmt.Errorf("compiling regex for artifact name for branch %s: %w", branch, err)
	}

	downloadURLs := make([]ArtifactInfo, 0)

	for _, artifact := range artifacts.Artifacts {
		if resultsRe.MatchString(artifact.GetName()) {
			url, _, err := client.Actions.DownloadArtifact(ctx, Owner, Repo, artifact.GetID(), 5)
			if err != nil {
				fmt.Printf("getting download URL for artifact ID %d: %v\n", artifact.GetID(), err)
				continue
			}

			downloadURLs = append(downloadURLs, ArtifactInfo{
				Name: artifact.GetName(),
				URL:  url.String(),
			})
		}
	}

	return downloadURLs, nil
}
