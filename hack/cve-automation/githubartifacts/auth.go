package githubartifacts

import (
	"bytes"
	"context"
	"fmt"
	"os"
	"os/exec"
	"strings"
	"time"
)

// GetToken attempts to get a GitHub token by first trying to run the `gh`
// executable, and if that fails, falling back to the GITHUB_TOKEN environment
// variable. This allows for flexibility in how the token is provided, and
// provides a positive escape hatch if the `gh` executable is available and
// properly configured.
//
// Token is needed for any subsequent calls to the GitHub API, such as listing
// artifacts. If neither method works, an error is returned.
func GetToken() (string, error) {
	ctx, cxl := context.WithTimeout(context.Background(), 5*time.Second)
	defer cxl()

	out := bytes.Buffer{}

	cmd := exec.CommandContext(ctx, "gh", "auth", "token")
	cmd.Stdout = &out

	err := cmd.Run()
	if err == nil {
		// This is a positive escape hatch! Return if all is well!
		return strings.TrimSpace(out.String()), nil
	}

	fmt.Println("running the 'gh' executable encountered an issue.\nTrying to get GitHub token using the GITHUB_TOKEN env variable instead.")

	token := os.Getenv("GITHUB_TOKEN")
	if token == "" {
		fmt.Printf("environment variable was empty\n")
		return "", fmt.Errorf("GITHUB_TOKEN environment variable is not set, and previously: %w", err)
	}

	return token, nil
}
