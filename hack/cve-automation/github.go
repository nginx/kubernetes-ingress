package main

import (
	"bytes"
	"context"
	"fmt"
	"os"
	"os/exec"
	"strings"
	"time"

	"github.com/google/go-github/v82/github"
	"golang.org/x/oauth2"
)

func getGitHubArtifacts(token string) ([]string, error) {
	ctx := context.Background()
	ts := oauth2.StaticTokenSource(&oauth2.Token{AccessToken: token})
	tc := oauth2.NewClient(ctx, ts)

	client := github.NewClient(tc)

	owner, repo := "nginx", "kubernetes-ingress"
	// 1) list artifacts
	arts, _, err := client.Actions.ListArtifacts(ctx, owner, repo, &github.ListArtifactsOptions{
		ListOptions: github.ListOptions{
			PerPage: 100,
		},
	})
	if err != nil {
		return nil, fmt.Errorf("unable to list artifacts: %w", err)
	}

	list := make([]string, len(arts.Artifacts))
	for i, art := range arts.Artifacts {
		list[i] = fmt.Sprintf("%d: %s (%s)", art.GetID(), art.GetName(), humanSizeBinary(art.GetSizeInBytes()))
	}
	return list, nil

	//
	//
	// id := arts.Artifacts[0].GetID()
	//
	// // 2) download: often you first get a redirect URL, then GET it
	// url, _, err := client.Actions.DownloadArtifact(ctx, owner, repo, id, 5)
	// if err != nil {
	// 	return nil, fmt.Errorf("downloading artifact: %w", err)
	// }
	//
	// r, err := http.Get(url.String())
	// if err != nil {
	// 	panic(err)
	// }
	// defer r.Body.Close()
	//
	// f, _ := os.Create("artifact.zip")
	// defer f.Close()
	// _, _ = f.ReadFrom(r.Body)
	// return nil, nil
}

func getGitHubToken() (string, error) {
	ctx, cxl := context.WithTimeout(context.Background(), 5*time.Second)
	defer cxl()

	out := bytes.Buffer{}

	cmd := exec.CommandContext(ctx, "gh", "auth", "token")
	cmd.Stdout = &out

	err := cmd.Run()
	if err == nil {
		// This is a positive escape hatch! Return is all is well!
		return strings.TrimSpace(out.String()), nil
	}

	fmt.Println("running the 'gh' executable encountered an issue.\nTrying to get GitHub token using the GITHUB_TOKEN env variable instead.")

	token := os.Getenv("GITHUB_TOKEN")
	if token == "" {
		fmt.Printf("environment variable was empty\n")
		return "", fmt.Errorf("GITHUB_TOKEN environment variable is not set, and previously: %w", err)
	}

	return token, nil
}
