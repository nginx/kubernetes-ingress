package reporter

import (
	"bytes"
	"fmt"
	"os"
	"path/filepath"
	"sort"
	"strings"
	"text/template"
	"time"
)

// templateFuncs returns the custom functions available in the CVE report template.
func templateFuncs() template.FuncMap {
	return template.FuncMap{
		"joinStrings": strings.Join,
		"uniqueNumericalSeverities": func(m map[string]string) string {
			seen := make(map[string]struct{})
			var unique []string
			for _, v := range m {
				if _, exists := seen[v]; !exists {
					seen[v] = struct{}{}
					unique = append(unique, v)
				}
			}
			sort.Strings(unique)
			return strings.Join(unique, ", ")
		},
		"uniqueTextSeverities": func(m map[string][]string) string {
			seen := make(map[string]struct{})
			var unique []string
			for _, tags := range m {
				for _, t := range tags {
					if _, exists := seen[t]; !exists {
						seen[t] = struct{}{}
						unique = append(unique, t)
					}
				}
			}
			sort.Strings(unique)
			return strings.Join(unique, ", ")
		},
	}
}

// RenderMarkdown renders the unique vulnerabilities into a Markdown report
// using the cve-report.md.tmpl template and writes the output to the reports/ directory.
// It returns the path to the written file.
// If suffix is provided, it will be appended to the filename before the extension.
func RenderMarkdown(vulnerabilities map[string]UniqueVulnerability, baseDirectory string, suffix string) (string, error) {
	// Sort vulnerabilities by ID for deterministic output.
	ids := make([]string, 0, len(vulnerabilities))
	for id := range vulnerabilities {
		ids = append(ids, id)
	}
	sort.Strings(ids)

	sorted := make([]UniqueVulnerability, 0, len(ids))
	for _, id := range ids {
		sorted = append(sorted, vulnerabilities[id])
	}

	tmplPath := filepath.Join(baseDirectory, "templates", "cve-report.md.tmpl")
	tmpl, err := template.New("cve-report.md.tmpl").Funcs(templateFuncs()).ParseFiles(tmplPath)
	if err != nil {
		return "", fmt.Errorf("parsing template %s: %w", tmplPath, err)
	}

	var buf bytes.Buffer
	if err := tmpl.Execute(&buf, sorted); err != nil {
		return "", fmt.Errorf("executing template: %w", err)
	}

	reportsDir := filepath.Join(baseDirectory, "reports")
	if err := os.MkdirAll(reportsDir, 0o750); err != nil {
		return "", fmt.Errorf("creating reports directory: %w", err)
	}

	filename := fmt.Sprintf("cve-report-%s", time.Now().Format("2006-01-02"))
	if suffix != "" {
		filename = fmt.Sprintf("%s-%s", filename, suffix)
	}
	filename = filename + ".md"
	outPath := filepath.Join(reportsDir, filename)

	err = os.WriteFile(outPath, buf.Bytes(), 0o644) //gosec:disable G306 -- this file needs to be readable by users, not executable
	if err != nil {
		return "", fmt.Errorf("writing report to %s: %w", outPath, err)
	}

	return outPath, nil
}
