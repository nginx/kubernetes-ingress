package main

import (
	"context"
	"fmt"

	"github.com/moby/moby/client"
)

func getDockerImages() (images []string, err error) {
	apiClient, err := client.New(client.FromEnv)
	if err != nil {
		panic(err)
	}
	defer func() {
		err = apiClient.Close()
		if err != nil {
			err = fmt.Errorf("closing docker api client: %w", err)
		}
	}()

	// list images
	result, err := apiClient.ImageList(context.Background(), client.ImageListOptions{
		All: true,
		Filters: map[string]map[string]bool{
			"reference": {
				"nginx/*": true,
			},
		},
	})
	if err != nil {
		return nil, fmt.Errorf("unable to list images: %w", err)
	}

	items := make([]string, len(result.Items))

	// Print each container's ID, status and the image it was created from.
	fmt.Printf("%s  %-22s  %s\n", "ID", "TAGS", "SIZE")
	for i, ctr := range result.Items {
		items[i] = fmt.Sprintf("%s  %v  %s\n", ctr.ID, ctr.RepoTags, humanSizeBinary(ctr.Size))
	}

	return items, nil
}

// getImagesWithFilter returns a list of docker images that match the given
// filter. If the filter is empty, it returns all images. Generally you will
// want to pass in `nginx/*` to get all images that start with `nginx/`.
func getImagesWithFilter(filter string) (images []image, err error) {
	filters := make(map[string]map[string]bool)
	if filter != "" {
		filters["reference"] = map[string]bool{
			filter: true,
		}
	}

	// Create a new client that handles common environment variables
	// for configuration (DOCKER_HOST, DOCKER_API_VERSION), and does
	// API-version negotiation to allow downgrading the API version
	// when connecting with an older daemon version.
	apiClient, err := client.New(client.FromEnv)
	if err != nil {
		return nil, fmt.Errorf("could not create docker api client: %w", err)
	}
	defer func() {
		err = apiClient.Close()
		if err != nil {
			err = fmt.Errorf("closing github api client: %w", err)
		}
	}()

	ctx, cxl := context.WithTimeout(context.Background(), getImagesTimeout)
	defer cxl()

	// list images
	result, err := apiClient.ImageList(ctx, client.ImageListOptions{
		All:     true,
		Filters: filters,
	})
	if err != nil {
		return nil, fmt.Errorf("could not list images: %w", err)
	}

	images = make([]image, 0, len(result.Items))

	for i, img := range result.Items {
		images[i] = image{
			id:   img.ID,
			tags: img.RepoTags,
			size: humanSizeBinary(img.Size),
		}
	}

	return images, nil
}
