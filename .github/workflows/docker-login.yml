name: Docker login

on:
  push:
    branches:
      - docker-image

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.ref_name }}-docker-login
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    name: Build docker image
    runs-on: ubuntu-22.04
    permissions:
        contents: read # for docker/build-push-action to read repo content
        security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
        id-token: write # for OIDC login to AWS ECR
        packages: write # for docker/build-push-action to push to GHCR
    steps:
      - name: Checkout Repository
        uses: actions/checkout@9bb56186c3b09b4f86b1c65136769dd318469633 # v4.1.2

      - name: Docker Buildx
        uses: docker/setup-buildx-action@0d103c3126aa41d772a8362f6aa67afac040f80c # v3.1.0

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@55bd3a7c6e2ae7cf1877fd1ccb9d54c0503c457c # v2.1.2
        with:
          token_format: access_token
          workload_identity_provider: ${{ secrets.GCR_WORKLOAD_IDENTITY }}
          service_account: ${{ secrets.GCR_SERVICE_ACCOUNT }}

      - name: Login to GCR
        uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
        with:
          registry: gcr.io
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}

      - name: Build Base Container
        uses: docker/build-push-action@af5a7ed5ba88268d5278f7203fb52cd833f66d6e # v5.2.0
        with:
          file: build/Dockerfile-login
          tags: gcr.io/f5-gcs-7899-ptg-ingrss-ctlr/dev/paul:${{ github.sha }}
          pull: true
          push: true
          secrets: |
            "docker-u=${{ secrets.DOCKER_USERNAME }}"
            "docker-p=${{ secrets.DOCKER_PASSWORD }}"
            "quay-u=${{ secrets.QUAY_USERNAME }}"
            "quay-p=${{ secrets.QUAY_ROBOT_TOKEN }}"
            "aws=${{ secrets.AWS_ROLE_PUBLIC_ECR }}"
