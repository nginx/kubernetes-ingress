name: Run Smoke Tests
description: Run Smoke Tests for the project

inputs:
  k8s-version:
    description: Kubernetes version to use
    required: false
  k8s-timeout:
    description: Timeout to use
    default: 75s
    required: false
  image-type:
    description: Image type to test
    required: true
  image-name:
    description: Docker image name to test
    required: true
  tag:
    description: Docker image tag to test
    required: true
  test-image:
    description: Test Docker image to use
    default: gcr.io/f5-gcs-7899-ptg-ingrss-ctlr/dev/test-runner:latest
    required: false
  marker:
    description: Marker to use
    required: false
  label:
    description: Label for test
    required: false
  registry-token:
    description: JWT token for accessing container registry
    required: false
  plus-jwt:
    description: JWT for NGINX Plus
    required: false

outputs:
  test-results-name:
    description: Test results name
    value: ${{ steps.k8s.outputs.test_name }}
  test-results-path:
    description: Test results full path
    value: ${{ steps.k8s.outputs.test_output_path }}

runs:
  using: composite
  steps:
    - name: Install k3d
      run: |
        curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
        k3d --version
      shell: bash

    - name: Deploy Kubernetes (k3d)
      id: k8s
      run: |
        # create k3d cluster with default resources like KIND/Minikube
        k3d cluster create ${{ github.run_id }} --wait \
          --servers 1 --agents 0 \
          --servers-memory 4g \
          --k3s-arg "--disable=traefik@server:*"

        kubectl wait --for=condition=Ready nodes --all --timeout=120s --kubeconfig ~/.kube/config
        docker save ${{ inputs.image-name }}:${{ inputs.tag }} | \
          docker exec --privileged -i k3d-${{ github.run_id }}-server-0 \
            ctr --namespace=k8s.io images import -
        label="${{ inputs.label }}"
        nospaces="${label// /_}"
        noslash="${nospaces//\//_}"
        sanitized_marker="${noslash//\'/}"
        name="${sanitized_marker}-${{ inputs.k8s-version }}"

        # server container for k3d cluster
        cluster_ip=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' k3d-${{ github.run_id }}-server-0)

        # validate network and cluster IP
        if [ -z "$cluster_ip" ]; then
          echo "Error: Could not get cluster IP from k3d-${{ github.run_id }}-server-0"
          docker ps --filter name=k3d-${{ github.run_id }}
          exit 1
        fi

        # verify k3d network exists
        if ! docker network inspect k3d-${{ github.run_id }} > /dev/null 2>&1; then
          echo "Error: k3d network k3d-${{ github.run_id }} not found"
          docker network ls
          exit 1
        fi

        test_name=tests-nginx-${{ inputs.image-type }}-${name}.html
        test_output_path=${{ github.workspace }}/tests/${test_name}
        echo "cluster_ip=${cluster_ip}" >> $GITHUB_OUTPUT
        echo "test_name=${test_name}" >> $GITHUB_OUTPUT
        echo "test_output_path=${test_output_path}" >> $GITHUB_OUTPUT
        echo "Output:"
        echo "  cluster_ip=${cluster_ip}"
        echo "  test_output_path=${test_output_path}"
      shell: bash

    - name: Setup Kubeconfig (k3d)
      run: |
        mkdir -p ~/.kube/k3d
        k3d kubeconfig get ${{ github.run_id }} > ~/.kube/k3d/config
        sed -i "s|server: https://0.0.0.0:[0-9]*|server: https://${{ steps.k8s.outputs.cluster_ip }}:6443|g" ~/.kube/k3d/config
        echo "Updated kubeconfig server to use cluster IP:"
        grep "server:" ~/.kube/k3d/config
      shell: bash

    - name: Run Smoke Tests
      id: smoke-tests
      run: |
        touch ${{ steps.k8s.outputs.test_output_path }}
        docker run --rm \
        --name test-runner-${{ github.run_id }} \
        --network=k3d-${{ github.run_id }} \
        -v "/var/run/docker.sock:/var/run/docker.sock" \
        -v ~/.docker:/root/.docker \
        -v ${{ github.workspace }}/tests:/workspace/tests \
        -v ${{ github.workspace }}/common-secrets:/workspace/common-secrets \
        -v ${{ github.workspace }}/deployments:/workspace/deployments \
        -v ${{ github.workspace }}/charts:/workspace/charts \
        -v ${{ github.workspace }}/config:/workspace/config \
        -v ${{ github.workspace }}/pyproject.toml:/workspace/pyproject.toml \
        -v ${{ steps.k8s.outputs.test_output_path }}:${{ steps.k8s.outputs.test_output_path }} \
        -v ~/.kube/k3d/config:/root/.kube/config ${{ inputs.test-image }} \
        --docker-registry-user=oauth2accesstoken \
        --docker-registry-token=${{ inputs.registry-token }} \
        --context=k3d-${{ github.run_id }} \
        --image=${{ inputs.image-name }}:${{ inputs.tag }} \
        --image-pull-policy=Never \
        --ic-type=nginx${{ contains(inputs.image-type, 'plus') && '-plus' || '' }}-ingress \
        --service=nodeport --node-ip=${{ steps.k8s.outputs.cluster_ip }} \
        --html=${{ steps.k8s.outputs.test_output_path }} \
        --self-contained-html \
        --durations=10 \
        --show-ic-logs=yes \
        --plus-jwt=${{ inputs.plus-jwt }} \
        -m ${{ inputs.marker != '' && inputs.marker || '""' }}
      working-directory: ./tests
      shell: bash
